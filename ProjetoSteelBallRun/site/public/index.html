<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="div_voltas">
    <div class="grupo_elemento">
      <select id="numero_voltas">
        <option value="0">Selecionar Voltas</option>
        <option value="5">5 Voltas</option>
        <option value="6">6 Voltas</option>
        <option value="7">7 Voltas</option>
        <option value="8">8 Voltas</option>
        <option value="9">9 Voltas</option>
        <option value="10">10 Voltas</option>
      </select>
    </div>
    <button onclick="continuar()">
      <span class="btn_text">Continuar</span>
    </button>
  </div>



  <div id="div_cavalos">
    <select id="numero_cavalos">
      <option value="0">Selecionar Quantidade Cavalos</option>
      <option value="3">3 Cavalos</option>
      <option value="4">4 Cavalos</option>
      <option value="5">5 Cavalos</option>
      <option value="6">6 Cavalos</option>
    </select>
    <button onclick="continuar()">
      <span class="btn_text">Continuar</span>
    </button>
    <div id="div_nomes"></div>
  </div>



  <div id="div_resp"></div>

  <div id="div_erro"> Valores Inválidos! Digite um valor numérico positivo! </div>

  <div id="div_nome_cavalos" style="display: none">
    <div class="input_nomes" id="input_nomes">
      <input id="nome_cavalos" /> Insira o nome do cavalo
      <button id="btn_inserir" onclick="adicionar()">Inserir</button>
    </div>
  </div>
  <button id="btn_largada" onclick="iniciar()">Largada</button>
  <button id="btn_podio" onclick="ver_podio()" style="display: none;">Ver o pódio</button>


  <div id="div_podio" style="display: none;">
    <div class="card_usuario" style="display: none;">
      <div id="usuario_conexao">
        <div id='div_login'>
          <h1>Faça o login para salvar sua partida</h1>
          <b>Nome de usuario</b>
          <input type="text" id="ipt_nome_usuario">
          <b>Senha</b>
          <input type="password" id="ipt_senha_usuario">
          <h4>Ainda não possui uma conta? <p onclick="cadastro()">Crie aqui!</p>
          </h4>
          <button onclick="login()">Login</button>
          <button onclick="voltar('sair')">Sair</button>
        </div>
        <div id="div_cadastro">
          <h1>Bem vindo ao Stell Ball Run!</h1>
          <h3>Faça seu cadastro para salvar suas partidas e participar do nosso Leaderboard!</h3>
          <b>Nome de usuario</b>
          <input type="text" id="ipt_nome_cadastro">
          <b>Senha</b>
          <input type="text" id="ipt_senha_cadastro">
          <b>Repetir Senha</b>
          <input type="text" id="ipt_confirmacao_cadastro">
          <button onclick="cadastrar()">Cadastre-se</button>
          <button onclick="voltar('login')">Voltar para o Login</button>
        </div>
        <div id="div_salvar">
          <h1>Salve sua partida!</h1>
          <h3>Salve e participe do LeaderBoard!</h3>
          <button onclick="salvar_partida()">Salvar Partida</button>
        </div>
      </div>
    </div>
    <div id="leaderboard"></div>
  </div>
</body>

</html>
<script>
  var cavalo_de_ouro = ''
  var cavalo_vencedor
  var qtde_voltas;
  var qtde_cavalos;
  var lista_cavalo = [];
  var lista_tempo = [];
  var contador_div = 0;

  function continuar() {
    // usando a mesma função para executar a mudança de diferentes DIVS utilizando
    // um contador
    contador_div++;
    if (contador_div == 1) {
      qtde_voltas = numero_voltas.value;
      if (qtde_voltas == 0) {
        // Aqui é para aparecer um erro e não seguir
        // Troque para a div erro
        alert("Selecione o número de voltas correto");
        contador_div--;
        return;
      }

      div_voltas.style.display = "none";
      div_cavalos.style.display = "flex";
    } else if (contador_div == 2) {
      qtde_cavalos = numero_cavalos.value;

      if (qtde_cavalos == 0) {
        // Aqui é para aparecer um erro e não seguir
        // Troque para a div erro
        alert("Selecione o número de cavalos correto");
        contador_div--;
        return;
      }

      div_voltas.style.display = "none";
      div_cavalos.style.display = "flex";
    } else if (contador_div == 3) {
      div_nome_cavalos.style.display = "flex";
      div_cavalos.style.display = "none";
    }
  }
  // divResp.style = "display:none;";
  // divErro.style = "display:none;";
  function iniciar() {
    btn_largada.style.display = "none";

    div_resp.innerHTML = "";
    for (let i = 1; i <= qtde_cavalos; i++) {
      lista_tempo.push(0);
    }



    for (let i = 1; i <= qtde_voltas; i++) {
      div_resp.innerHTML += `<span class='numeroVolta'>${i}ª Volta</span><br>`;
      for (let j = 0; j < lista_cavalo.length; j++) {
        let random = Number((7 + Math.random() * 2).toFixed(5));
        lista_tempo[j] += random;
        console.log(`${lista_tempo[j]}`)
        div_resp.innerHTML += `
                              <div class='card_cavalo'>
                                  <span class='nome_cavalo'>Cavalo ${lista_cavalo[j]}</span>
                                  <span class='label'>Tempo da Volta: ${random} minutos</span>
                                  <span class='label'>Tempo Acumulado: ${lista_tempo[j].toFixed(1)} minutos</span>
                              </div>
                              <br>
                          `;
      }
      div_resp.innerHTML += `<br><br>`
    }
    btn_podio.style.display = "block"
    div_resp.style = "display:flex;"
  }
  // Inserção de nomes no vetor ordernado
  var ax_cavalos = ""

  function adicionar() {
    ax_cavalos = nome_cavalos.value
    if (ax_cavalos == "") {
      alert("Insira o nome do cavalo");
    } else {
      lista_cavalo.push(ax_cavalos)
      nome_cavalos.value = "";
      if (lista_cavalo.length == qtde_cavalos) {
        nome_cavalos.style.display = "none";
        btn_largada.style.display = "block";
        btn_inserir.style.display = "none";
      }
    }
  }

  function ver_podio() {
    let nome_podio = []
    let tempo_podio = []
    for (let i = 0; i < 3; i++) {
      let indexDo = lista_tempo.indexOf(Math.min(...lista_tempo))
      nome_podio.push(lista_cavalo[indexDo])
      tempo_podio.push(lista_tempo[indexDo])
      // O console diz que aqui não é uma function
      lista_tempo.splice(indexDo, 1)
      lista_cavalo.splice(indexDo, 1)
    }
    nome_podio.reverse()
    tempo_podio.reverse()

    div_resp.style.display = 'none'
    btn_podio.style.display = 'none'
    div_podio.style.display = 'flex'

    cavalo_vencedor = nome_podio[0]

    div_podio.innerHTML += `
            <div class='lugar2'> 
              ${nome_podio[1]}
            </div>
            <div class='lugar1'> 
              ${nome_podio[0]}
            </div>
            <div class='lugar3'> 
              ${nome_podio[2]}
            </div>
      `
  }

  // BACKEND

  function voltar(local) {
    if (local == 'sair') {
      cobre_pagina.style.display = `none`;
    } else {
      div_cadastro.style.display = `none`;
      div_login.style.display = `flex`;
    }
  }

  function cadastro() {
    div_cadastro.style.display = `flex`;
    div_login.style.display = `none`;
  }

  function cadastrar() {

    var nomeVar = ipt_nome_cadastro.value;
    var senhaVar = ipt_senha_cadastro.value;
    var confirmacaoSenhaVar = ipt_confirmacao_cadastro.value;
    var verificacaoVar = true

    if (nomeVar == "" || senhaVar == "" || confirmacaoSenhaVar == "") {
      alert(`Não podem existir campos em branco.`)
      return false;
    } else if (senhaVar != confirmacaoSenhaVar) {
      alert(`As senhas não coincidem`)
    }

    // VERIFICANDO SE JÁ NÃO EXISTE O NICK CADASTRADO

    fetch("/usuarios/autenticar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        nomeServer: nomeVar,
        senhaServer: senhaVar,
        verificacaoServer: verificacaoVar
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO entrar()!")

      if (resposta.ok) {
        // Enviando o valor da nova input
        if (resposta[0] != nomeVar) {
          fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              nomeServer: nomeVar,
              senhaServer: senhaVar
            })

          }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

            } else {
              throw ("Houve um erro ao tentar realizar o cadastro!");
            }
          }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });

          return false;
        } else {
          alert(`Foi encontrado um usuário com este nome, por favor insira um nome diferente.`)
          return false;
        }

      }
    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function login() {
    var nomeVar = ipt_nome_usuario.value;
    var senhaVar = ipt_senha_usuario.value;
    var verificacaoVar = false

    if (nomeVar == "" || senhaVar == "") {
      alert(`Não podem existir campos em branco.`)
      return false;
    }

    fetch("/usuarios/autenticar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        nomeServer: nomeVar,
        senhaServer: senhaVar,
        verificacaoServer: verificacaoVar
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO entrar()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          sessionStorage.NICK_USUARIO = json.nick;
          sessionStorage.ID_USUARIO = json.idUsuario;
          div_salvar.style.display = `flex`;
        });

      } else {

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function salvar_partida() {
    let = resultadoPartidaVar
    cobre_pagina.style.display = `flex`;

    fetch("/partidas/cadastrarPartida", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        qtdeCavalosServer: qtde_cavalos.value,
        qtdeVoltasServer: qtde_voltas.value
      })

    }).then(function (resposta) {

      console.log("resposta: ", resposta);

      if (resposta.ok) {

      } else {
        throw ("Houve um erro ao tentar realizar o cadastro!");
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });

    fetch("/usuarios/autenticarPartida", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO entrar()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          sessionStorage.ID_PARTIDA = json.idPartida;
        });
      }
    })

    if(cavalo_de_ouro == cavalo_vencedor){
      resultadoPartidaVar = 'Ganhador'
    }else{
      resultadoPartidaVar = 'Perdedor'
    }

    fetch("/partidas/cadastrarResultado", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkPartidaServer: sessionStorage.ID_PARTIDA,
        fkUsuario: sessionStorage.ID_USUARIO,
        cavaloServer: nome_podio[0],
        resultadoServer: resultadoParidaVar
      })


    }).then(function (resposta) {

      console.log("resposta: ", resposta);

      if (resposta.ok) {

      } else {
        throw ("Houve um erro ao tentar realizar o cadastro!");
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });

    fetch("/usuarios/autenticarResultado", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO entrar()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          sessionStorage.ID_RESULTADO = json.idResultado;
        });
      }
    })

    fetch("/leaderboard/cadastrarLeaderboard", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkPartidaServer: sessionStorage.ID_PARTIDA,
        fkUsuario: sessionStorage.ID_USUARIO,
        cavaloServer: nome_podio[0],
        resultadoServer: resultadoParidaVar
      })


    }).then(function (resposta) {

      console.log("resposta: ", resposta);

      if (resposta.ok) {

      } else {
        throw ("Houve um erro ao tentar realizar o cadastro!");
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });

  }
</script>